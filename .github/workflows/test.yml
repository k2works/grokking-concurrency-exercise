name: Test All Apps

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - app: java
            nix-shell: java
            test-command: "gradle test"
          - app: clojure
            nix-shell: clojure
            test-command: "lein test"
          - app: rust
            nix-shell: rust
            test-command: "cargo test"
          - app: scala
            nix-shell: scala
            test-command: "sbt test"
          - app: haskell
            nix-shell: haskell
            test-command: "stack test --system-ghc --no-install-ghc"
          - app: csharp
            nix-shell: dotnet
            test-command: "dotnet test"
          - app: fsharp
            nix-shell: dotnet
            test-command: "dotnet test"

    name: ${{ matrix.app }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Run tests
        run: |
          nix develop .#${{ matrix.nix-shell }} --command bash -c "
            cd apps/${{ matrix.app }}
            ${{ matrix.test-command }}
          "
